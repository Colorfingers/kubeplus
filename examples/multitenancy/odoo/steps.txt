Odoo as-a-Service
-------------------
This is an example of delivering a Bitnami Odoo Helm chart as-a-service using KubePlus


1. Download Odoo helm chart from Bitnami:
   - helm repo add bitnami https://charts.bitnami.com/bitnami
   - helm pull bitnami/odoo

2. Install KubePlus and setup KubePlus kubectl plugins
   - python ../../../provider-kubeconfig.py create default
   - helm install kubeplus "https://github.com/cloud-ark/operatorcharts/blob/master/kubeplus-chart-3.0.12.tgz?raw=true" --kubeconfig=kubeplus-saas-provider.json 
   - Wait till KubePlus Pod is Running

   - Setup KubePlus kubectl plugins
     wget https://github.com/cloud-ark/kubeplus/blob/master/kubeplus-kubectl-plugins.tar.gz
     gunzip kubeplus-kubectl-plugins.tar.gz
     tar -xvf kubeplus-kubectl-plugins
     export KUBEPLUS_HOME=`pwd`
     export PATH=$KUBEPLUS_HOME/plugins:$PATH

3. Create OdooService API wrapping the Helm chart
   - kubectl upload chart odoo-23.0.4.tgz 
   - kubectl create -f odoo-service-composition-localhcart.yaml --kubeconfig=kubeplus-saas-provider.json 
   - kubectl get crds
     - verify that odooservice crd has been created
     - check that OpenAPISchema has been defined on the CRD corresponding to the attributes in the values.yaml of the Odoo Helm chart. 

4. Download the consumer kubeconfig file
   - kubectl get configmaps kubeplus-saas-consumer-kubeconfig -n $KUBEPLUS_NS -o jsonpath="{.data.kubeplus-saas-consumer\.json}" > consumer.conf
   
In the below commands you can use consumer.conf or kubeplus-saas-provider.json

5. Check the man page for OdooService API
   - kubectl explain OdooService
   - kubectl explain OdooService.spec
   - kubectl man OdooService -k kubeplus-saas-provider.json
     - this will show the Odoo Helm chart's values.yaml file

6. Create Odoo instance
   - kubectl man OdooService -k kubeplus-saas-provider.json > sample-odooservice.yaml
   - Open sample-odooservice.yaml and make following changes
     - set OdooService.spec.service.type to "NodePort"
     - set OdooService.spec.service.nodePorts.http to "30001"
   - kubectl create -f sample-odooservice.yaml --kubeconfig=kubeplus-saas-provider.json
     - verify that the application Pods are created in a new namespace (kubectl get pods -A)

7. Check the created resources
   - kubectl appresources OdooService sample-odooservice -k kubeplus-saas-provider.json
     - this will show all the resources that KubePlus has created for the odoo instance

8. Check logs
   - kubectl applogs OdooService sample-odooservice default -k kubeplus-saas-provider.json 

9. Check application URL
    - appurl=`kubectl appurl OdooService sample-odooservice default -k kubeplus-saas-provider.json`
    - curl $appurl/web/login
      - if the installation is successful, the curl call should return 200 OK.

10. Check metrics
    - kubectl metrics OdooService sample-odooservice default -k kubeplus-saas-provider.json 
    - kubectl metrics OdooService sample-odooservice default -k kubeplus-saas-provider.json -o prometheus

11. Check resource topology
    - kubectl connections OdooService sample-odooservice default -k kubeplus-saas-provider.json -o png


Clean up:
- kubectl delete -f sample-odooservice.yaml --kubeconfig=kubeplus-saas-provider.json
- kubectl delete -f odoo-service-composition-localchart.yaml --kubeconfig=kubeplus-saas-provider.json



